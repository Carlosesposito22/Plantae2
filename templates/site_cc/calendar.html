{% extends 'base/base.html' %}
{% load static %}
{% block title %}Calendário{% endblock title %}

{% block extracss %}
  <link href="{% static 'calender/main.css' %}" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.10/css/weather-icons.min.css">
  
  <style>
    #calendar {
        border: 1px solid #ccc;
        border-radius: 8px;
        overflow: hidden;
    }

    .fc-event {
        background-color: #4D933E !important;
        color: white;
        border-radius: 5px;
        padding: 10px;
        margin: 5px 0;
        transition: transform 0.2s;
    }

    .fc-event:hover {
        transform: scale(1.05);
    }

    .coluna-ongoing {
        background-color: #F2F7F2;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        max-height: 45.5rem;
        overflow-y: scroll;
    }

    .modal-header {
        background-color: #4D933E !important;
    }

    .modal-title {
        font-weight: bold;
    }

    .save-btn {
        background-color: #4D933E;
        border-color: #096d10;
    }

    .save-btn:hover {
        background-color: #2c5f20 !important;
        border-color: #00570d !important;
    }

    .btn-primary:hover {
        background-color: #515151;
    }

    .day-icon {
        width: 20px;
        height: 20px;
        cursor: pointer;
        position: absolute;
        top: 5px;
        left: 5px;
    }
</style>
{% endblock extracss %}

{% block breadcrumb %}
<h1><i class="fa fa-calendar"></i> Calendário</h1>
{% endblock breadcrumb %}

{% block content %}
<div class="row">
    <div class="coluna-ongoing col-md-3">
        <h4 class="mb-4">Eventos em andamento</h4>
        {% for event in events_month %}
          <div class="fc-event" data-event-id="{{ event.id }}">
              <h4>{{ event.title }}</h4>
              <p><strong>Tipo: </strong>{{ event.type }}</p>
              <p><strong>Cultura: </strong>{{ event.cultura }}</p>
              <p><strong>Local: </strong>{{ event.local }}</p>
              <p><strong>Descrição: </strong>{{ event.description }}</p>
              <p><strong>Data Início: </strong>{{ event.start_time|date:"d \d\e F \d\e Y" }}</p> 
              <p><strong>Data Fim: </strong>{{ event.end_time|date:"d \d\e F \d\e Y" }}</p> 
              <p><strong>Duração: </strong>{{ event.duration }}</p>
          </div>
        {% empty %}
          <p>Nenhuma cultura em andamento</p>
        {% endfor %}
    </div>
    <div class="col-md-9">
        <div id="calendar"></div>
    </div>

    <!-- Modal para Adicionar Plantação -->
    <div class="modal fade" id="eventModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-white">Adicionar Plantação</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <form method="post" id="eventForm">
                    {% csrf_token %}
                    <input type="hidden" id="id_event_id" name="event_id">
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Evento:</label>
                            {{ form.title }}
                        </div>
                        <div class="form-group">
                            <label>Tipo:</label>
                            {{ form.type }}
                        </div>
                        <div class="form-group">
                            <label>Cultura:</label>
                            {{ form.cultura }}
                        </div>
                        <div class="form-group">
                            <label>Local:</label>
                            {{ form.local }}
                        </div>
                        <div class="form-group">
                            <label>Descrição:</label>
                            {{ form.description }}
                        </div>
                        <div class="form-group">
                            <label>Início:</label>
                            {{ form.start_time }}
                        </div>
                        <div class="form-group">
                            <label>Fim:</label>
                            {{ form.end_time }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Fechar</button>
                        <button type="submit" class="btn btn-primary save-btn">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para recomendação de colheita -->
    <div class="modal fade" id="recommendationModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-white">Recomendação de Colheita</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="recommendationMessage" style="font-weight: bold; color: #333;"></p>
                    <p>Sugestão: Avalie a colheita para este período.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" id="btn-nv-btn">Criar</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Detalhes do Evento -->
    <div class="modal fade" id="detailModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-white" id="title_event_detail"></h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p><strong>Tipo:</strong> <span id="type_event_detail"></span></p>
                    <p><strong>Cultura:</strong> <span id="cultura_event_detail"></span></p>
                    <p><strong>Local:</strong> <span id="local_event_detail"></span></p>
                    <p><strong>Descrição:</strong> <span id="description_event_detail"></span></p>
                    <p><strong>Data Início:</strong> <span id="start_event_detail"></span></p>
                    <p><strong>Data Fim:</strong> <span id="end_event_detail"></span></p>
                    <p><strong>Duração:</strong> <span id="duration_readable_event_detail"></span></p>
                </div>
                <div class="modal-footer">
                    <button id="edit-event-button" data-event-id="" type="button" class="btn btn-primary">Editar</button>
                    <button id="delete-event-button" data-event-id="" type="button" class="btn btn-danger">Apagar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Previsão do Tempo -->
    <div class="modal fade" id="weatherModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalDate"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p><strong>Tempo:</strong> <span id="modalDescription"></span></p>
                    <p><strong>Temperatura:</strong> <span id="modalTemperature"></span></p>
                    <p><strong>Umidade:</strong> <span id="modalHumidity"></span></p>
                    <p><strong>Vento:</strong> <span id="modalWind"></span></p>
                    <p><strong>Precipitação:</strong> <span id="modalPrecipitation"></span></p>
                    <p><strong>Índice UV:</strong> <span id="modalUV"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
</div>

{{ previsoes|json_script:"weatherData" }}

{% endblock content %}
{% block extrascripts %}
<script src="{% static 'calender/main.js' %}"></script>
<script>
    const CULTURA_PRAZOS = {
        'Tomate': 105,
        'Cenoura': 85,
        'Alface': 38,
        'Batata': 105,
        'Rúcula': 35,
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        $('#recommendationModal').modal({
            backdrop: 'static',
            keyboard: false,
            show: false
        });

        document.getElementById('eventForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const eventType = document.querySelector('#id_type').value;

            let url = (eventType === "Plantio") ? "{% url 'site_cc:event_new_plantio' %}" : "{% url 'site_cc:event_new' %}";

            const formData = new FormData(this);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message || "Eventos criados com sucesso!");

                    calendar.addEvent({
                        id: data.event_id,
                        title: data.title,
                        description: data.description,
                        start: data.start_time,
                        end: data.end_time,
                        type: data.type,
                        cultura: data.cultura,
                        local: data.local,
                    });

                    $('#eventModal').modal('hide');

                    if (data.open_recommendation_modal) {
                        $('#recommendationModal').modal('show');
                        console.log(data.cultura);
                        const diasColheita = CULTURA_PRAZOS[data.cultura];
                        document.getElementById('recommendationMessage').textContent = 
                            `Recomendação para ${data.cultura}: Avalie a colheita para este período. A colheita ocorrerá em aproximadamente ${diasColheita} dias.`;

                        document.getElementById('btn-nv-btn').addEventListener('click', function() {
                            fetch(`/event/plantio/${data.event_id}/create_colheita/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': csrftoken
                                }
                            })
                            .then(response => response.json())
                            .then(colheitaData => {
                                if (colheitaData.success) {
                                    alert(colheitaData.message);
                                    calendar.addEvent({
                                        id: colheitaData.colheita_event_id,
                                        title: `${data.title} - Colheita`,
                                        start: new Date(new Date(data.start_time).getTime() + (diasColheita * 24 * 60 * 60 * 1000)),
                                        end: new Date(new Date(data.end_time).getTime() + (diasColheita * 24 * 60 * 60 * 1000)),
                                        type: "Colheita",
                                        cultura: data.cultura,
                                        local: data.local,
                                    });
                                } else {
                                    alert("Erro: " + colheitaData.message);
                                }
                            })
                            .catch(error => console.error('Erro ao criar evento de colheita:', error));
                        });
                    } else {
                        window.location.href = "{% url 'site_cc:calendar' %}";
                    }
                } else if (data.errors) {
                    alert("Erro ao salvar o evento: " + JSON.stringify(data.errors));
                }
            });
        });

        var calendarEl = document.getElementById('calendar');
        var previsoes = JSON.parse(document.getElementById('weatherData').textContent);
        let displayedIconsCount = 0;
        const descriptionIcons = {
            'Possibilidade de chuva irregular': 'wi wi-day-sprinkle',
            'Ensolarado': 'wi wi-day-sunny',
            'Nublado': 'wi wi-cloudy',
            'Tempestade': 'wi wi-storm-showers',
            'Neve': 'wi wi-snow',
            'Neblina': 'wi wi-fog',
            'Chuva moderada': 'wi wi-rain',
            'Chuva forte': 'wi wi-rain-wind',
            'Parcialmente nublado': 'wi wi-day-cloudy',
        };
        var calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'pt-br',
            headerToolbar: { 
                left: 'prev,next today', 
                center: 'title', 
                right: 'dayGridMonth,list' 
            },
            buttonText: {
                today: 'Hoje',
                month: 'Mês',
                list: 'Tarefas do dia'
            },
            initialDate: new Date(),
            navLinks: true,
            selectable: true,
            select: function(arg) {
                document.getElementById('id_event_id').value = "";
                document.getElementById('id_start_time').value = converterDataParaDjangoFormat(arg.start);
                document.getElementById('id_end_time').value = converterDataParaDjangoFormat(arg.end);
                $('#eventModal').modal('show');
                calendar.unselect();
            },
            eventClick: function(arg) {
                document.getElementById('title_event_detail').textContent = arg.event.title;
                document.getElementById('description_event_detail').textContent = arg.event.extendedProps.description || '';
                document.getElementById('start_event_detail').textContent = formatDateTime(arg.event.start);
                document.getElementById('end_event_detail').textContent = formatDateTime(arg.event.end);
                document.getElementById('type_event_detail').textContent = arg.event.extendedProps.type || 'Sem tipo';
                document.getElementById('local_event_detail').textContent = arg.event.extendedProps.local || 'Sem local';
                document.getElementById('cultura_event_detail').textContent = arg.event.extendedProps.cultura || 'Sem cultura';
                document.getElementById('duration_readable_event_detail').textContent = arg.event.extendedProps.duration_readable || 'Duração não disponível';
                document.getElementById('edit-event-button').setAttribute("data-event-id", arg.event.id);
                document.getElementById('delete-event-button').setAttribute("data-event-id", arg.event.id);
                $('#detailModal').modal('show');
            },
            editable: false,
            dayMaxEvents: true,
            events: {{ events|safe }},
            eventDidMount: function(info) {
                var eventType = info.event.extendedProps.type;
                if (eventType) {
                    info.el.classList.add(eventType);
                }
            },
            dayCellDidMount: function(args) {
                const dateStr = args.date.toISOString().split('T')[0];
                const forecast = previsoes[dateStr];

                if (forecast && displayedIconsCount < 7) {
                    const cellContent = args.el.querySelector('.fc-daygrid-day-frame');

                    let iconClass = descriptionIcons[forecast.descricao] || descriptionIcons['Nublado'];

                    const icon = document.createElement('i');
                    icon.className = `${iconClass} day-icon`;
                    icon.style.position = 'absolute';
                    icon.style.top = '5px';
                    icon.style.left = '5px';
                    icon.style.fontSize = "20px";
                    icon.style.cursor = "pointer";
                    icon.style.color = "green";

                    icon.onclick = function(event) {
                        event.stopPropagation();
                        openWeatherModal(dateStr);
                    };

                    cellContent.appendChild(icon);
                    displayedIconsCount++;
                }
            },

            datesSet: function() {
                displayedIconsCount = 0;
            }
        });

        calendar.render();

        window.openWeatherModal = function(dateStr) {
            const forecast = previsoes[dateStr];
            
            if (forecast) {
                document.getElementById('modalDate').textContent = new Date(dateStr).toLocaleDateString('pt-BR');
                document.getElementById('modalDescription').textContent = forecast.descricao;
                document.getElementById('modalTemperature').textContent = `Máx: ${forecast.temperatura_max}°C / Mín: ${forecast.temperatura_min}°C`;
                document.getElementById('modalHumidity').textContent = `Umidade: ${forecast.umidade}%`;
                document.getElementById('modalWind').textContent = `Vento: ${forecast.vento} km/h`;
                document.getElementById('modalPrecipitation').textContent = `Precipitação: ${forecast.precipitacao} mm`;
                document.getElementById('modalUV').textContent = `Índice UV: ${forecast.indice_uv}`;
                $('#weatherModal').modal('show');
            }
        };

        document.getElementById('edit-event-button').addEventListener('click', function() {
            const eventId = this.getAttribute('data-event-id');
            document.getElementById('id_event_id').value = eventId;

            document.getElementById('id_title').value = document.getElementById('title_event_detail').textContent;
            document.getElementById('id_type').value = document.getElementById('type_event_detail').textContent;
            document.getElementById('id_cultura').value = document.getElementById('cultura_event_detail').textContent;
            document.getElementById('id_local').value = document.getElementById('local_event_detail').textContent;
            document.getElementById('id_description').value = document.getElementById('description_event_detail').textContent;

            let startDateStr = document.getElementById('start_event_detail').textContent.trim();
            let endDateStr = document.getElementById('end_event_detail').textContent.trim();

            let startDate = parseDateBR(startDateStr);
            let endDate = parseDateBR(endDateStr);

            if (startDate) {
                document.getElementById('id_start_time').value = startDate.toISOString().slice(0, 19);
            } else {
                console.error("Data de início inválida:", startDateStr);
            }

            if (endDate) {
                document.getElementById('id_end_time').value = endDate.toISOString().slice(0, 19);
            } else {
                console.error("Data de fim inválida:", endDateStr);
            }

            $('#detailModal').modal('hide');
            $('#eventModal').modal('show');
        });

        document.getElementById('delete-event-button').addEventListener('click', function() {
            const eventId = this.getAttribute('data-event-id');
            if (confirm('Tem certeza que deseja apagar este evento?')) {
                fetch(`/delete_event/${eventId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    window.location.reload();
                })
                .catch(error => console.error('Erro ao excluir evento:', error));
            }
        });

        function converterDataParaDjangoFormat(data) {
            const dataJS = new Date(data);
            return `${dataJS.getFullYear()}-${(dataJS.getMonth() + 1).toString().padStart(2, '0')}-${dataJS.getDate().toString().padStart(2, '0')}T` +
                   `${dataJS.getHours().toString().padStart(2, '0')}:${dataJS.getMinutes().toString().padStart(2, '0')}:${dataJS.getSeconds().toString().padStart(2, '0')}`;
        }

        function formatDateTime(dateTime) {
            return new Date(dateTime).toLocaleString('pt-BR', { dateStyle: 'full', timeStyle: 'short' });
        }

        function parseDateBR(dateStr) {
            let regex = /(\d{1,2}) de (\w+) de (\d{4}) às (\d{2}):(\d{2})/;
            let matches = regex.exec(dateStr);
            
            if (matches) {
                let day = parseInt(matches[1], 10);
                let month = getMonthNumber(matches[2].toLowerCase());
                let year = parseInt(matches[3], 10);
                let hours = parseInt(matches[4], 10);
                let minutes = parseInt(matches[5], 10);

                return new Date(year, month - 1, day, hours, minutes);
            }
            return null;
        }

        function getMonthNumber(monthStr) {
            const months = {
                'janeiro': 1, 'fevereiro': 2, 'março': 3, 'abril': 4,
                'maio': 5, 'junho': 6, 'julho': 7, 'agosto': 8,
                'setembro': 9, 'outubro': 10, 'novembro': 11, 'dezembro': 12
            };
            return months[monthStr] || 0;
        }
    });
</script>
{% endblock extrascripts %}
