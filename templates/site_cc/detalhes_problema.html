{% extends 'base/base.html' %}
{% load static %}

{% block breadcrumb %}
<div>
    <h1><i class="app-menu__icon fa fa-bug"></i> Detalhe o problema da sua plantação</h1>
</div>
{% endblock breadcrumb %}

{% block extracss %}
<link rel="stylesheet" href="{% static 'css/cards.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    body {
        background-color: #f5f5f5; /* Fundo mais agradável visualmente */
    }

    .container-flex {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        max-width: 1200px;
        margin: 30px auto;
    }

    .problem-form,
    .resultado-container {
        background-color: #ffffff; /* Cor de fundo */
        border: 2px solid #28a745; /* Borda verde */
        border-radius: 15px; /* Cantos arredondados */
        padding: 30px; /* Espaçamento interno */
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); /* Sombra suave */
        display: flex;
        flex-direction: column; /* Permite o alinhamento vertical */
        flex: 1; /* Faz as duas áreas ocuparem a mesma altura */
        height: 640px; /* Altura fixa para o contêiner */
        overflow: hidden; /* Esconde qualquer conteúdo que ultrapasse a altura */
    }

    .form-textarea {
        flex: 1; /* Faz o textarea crescer para ocupar espaço */
        width: 100%; /* Largura completa do textarea */
        border: 1px solid #ccc; /* Borda cinza */
        border-radius: 8px; /* Cantos arredondados */
        padding: 15px; /* Espaçamento interno */
        font-size: 18px; /* Tamanho da fonte aumentado */
        resize: none; /* Não permite redimensionar */
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1); /* Sombra interna */
        margin-bottom: 15px; /* Margem inferior */
    }

    .resultado-container {
        overflow-y: auto; /* Adiciona rolagem vertical */
    }

    .section-title {
        text-align: center; /* Centraliza o título da seção */
        font-size: 28px; /* Tamanho da fonte do título */
        margin-bottom: 20px; /* Margem inferior */
        color: #333; /* Cor do texto */
    }

    .plantio-info {
        background-color: #e9f5e9; /* Fundo leve para destacar */
        border: 1px solid #28a745; /* Borda verde */
        border-radius: 10px; /* Cantos arredondados */
        padding: 15px; /* Espaçamento interno */
        margin-bottom: 20px; /* Margem inferior */
        display: flex; /* Usa flexbox para melhor alinhamento */
        align-items: center; /* Alinha os itens verticalmente ao centro */
        justify-content: flex-start; /* Alinha os itens à esquerda */
        height: 80px; /* Defina uma altura fixa desejada */
    }

    .plantio-info i.icon {
        font-size: 2em; /* Aumenta o tamanho do ícone */
        margin-right: 10px; /* Espaço entre o ícone e o texto */
        color: #28a745; /* Cor verde para o ícone */
    }

    .plantio-info .icon2 {
        font-size: 1.4em; /* Aumenta o tamanho do ícone */
        margin-right: 10px; /* Espaço entre o ícone e o texto */
        color: #28a745; /* Cor verde para o ícone */
    }

    .plantio-name {
        font-weight: bold; /* Texto em negrito */
        font-size: 20px; /* Tamanho da fonte do plantio selecionado */
        color: #28a745; /* Cor verde */
        margin: 0; /* Remove margens para melhor alinhamento */
    }

    .btn-submit {
        background-color: #28a745; /* Cor do botão */
        color: white; /* Cor do texto do botão */
        border: none; /* Remove a borda */
        border-radius: 2rem; /* Cantos arredondados */
        padding: 12px 25px; /* Espaçamento interno do botão */
        font-size: 20px; /* Tamanho da fonte do botão */
        cursor: pointer; /* Muda o cursor ao passar o mouse */
        transition: background-color 0.3s, transform 0.2s; /* Transições suaves */
    }

    .btn-submit:hover {
        background-color: #218838; /* Cor do botão ao passar o mouse */
        transform: translateY(-2px); /* Levanta o botão ao passar o mouse */
        color: white;
    }

    .btn-submit:active {
        transform: translateY(1px); /* Efeito de pressão ao clicar */
    }

    .resultado-container h3 {
        margin-bottom: 10px; /* Margem inferior */
        color: #28a745; /* Cor do título */
    }

    .resultado-container p {
        font-size: 18px; /* Tamanho da fonte dos parágrafos */
        margin: 5px 0; /* Margem vertical */
    }

    .resultado-info {
        margin-top: 15px; /* Margem superior */
    }

    .resultado-item {
        font-size: 18px; /* Tamanho da fonte */
        margin: 10px 0; /* Margens verticais */
        color: #333; /* Cor do texto principal */
    }

    .resultado-item strong {
        color: #28a745; /* Verde para os rótulos */
    }

    .resultado-dado {
        color: #333; /* Verde para os dados */
        font-weight: bold; /* Texto em negrito */
    }
</style>
{% endblock extracss %}

{% block content %}
<div class="container-flex">
    <form id="detalheProblemaForm" class="problem-form" method="post">
        {% csrf_token %}
        <div class="plantio-info">
            {% if plantio_selecionado == "Batata" %}
                <i class="fas fa-seedling icon"></i>
            {% elif plantio_selecionado == "Cenoura" %}
                <i class="fas fa-carrot icon"></i>
            {% elif plantio_selecionado == "Tomate" %}
                <i class="fas fa-apple-alt icon"></i>
            {% elif plantio_selecionado == "Alface" %}
                <i class="fas fa-leaf icon"></i>
            {% elif plantio_selecionado == "Rucula" %}
                <i class="fas fa-spa icon"></i>
            {% endif %}
            <p class="plantio-name">{{ plantio_selecionado }}</p>
        </div>  
        <input type="hidden" name="plantio" value="{{ plantio_selecionado }}">
        <textarea id="detalhes" name="detalhes" rows="6" placeholder="Descreva o problema..." class="form-textarea"></textarea>
        <button type="submit" class="btn btn-submit">Resolva meu problema <i class="bi bi-send-fill" style="margin-left: 0.8rem;"></i></button>
    </form>

    <div class="resultado-container">
        <div class="plantio-info">
            <p class="plantio-name"><i class="fas fa-lightbulb icon2"></i> Possíveis pragas e doenças encontradas:</p>
        </div>
        <div id="resultadoRecomendacao" class="resultado">
            <!-- O resultado será inserido aqui pelo script -->
        </div>
    </div>
</div>

<div class="col-md-13">
    <div class="tile-13">
        <div class="tile-body-13">
            <div class="table-responsive-13">
                <div id="sampleTable_wrapper-13" class="dataTables_wrapper container-fluid dt-bootstrap4 no-footer">
                    <div class="row-13">
                        <div class="col-sm-12">
                            <table class="table table-hover table-bordered dataTable" id="sampleTable-13">
                                <thead>
                                    <tr>
                                        <th>N°</th>
                                        <th>Tipo de plantio</th>
                                        <th>Data de reporte</th>
                                        <th>Descrição do problema</th>
                                        <th>Resolvido?</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Os dados serão inseridos aqui via script -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Script para AJAX -->
<script>
    document.getElementById('detalheProblemaForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Impede o envio padrão do formulário
        const formData = new FormData(this);
        const resultadoDiv = document.getElementById('resultadoRecomendacao');
    
        // Envia os dados via AJAX
        fetch("{% url 'site_cc:salvar_problema' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Atualiza a tabela com os problemas mais recentes
                const problemas = JSON.parse(data.problemas);
                const tabelaCorpo = document.querySelector('#sampleTable-13 tbody');
                tabelaCorpo.innerHTML = problemas.map((problema, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${problema.fields.plantio}</td>
                        <td>${new Date(problema.fields.data_reporte).toLocaleString()}</td>
                        <td>${problema.fields.descricao}</td>
                        <td>${problema.fields.resolvido ? 'Sim' : 'Não'}</td>
                    </tr>
                `).join('');
            } else {
                resultadoDiv.innerHTML = '<p>Erro ao salvar os dados.</p>';
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            resultadoDiv.innerHTML = '<p>Erro ao processar a solicitação.</p>';
        });
    });
    
</script>
{% endblock content %}
