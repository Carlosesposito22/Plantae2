{% extends 'base/base.html' %}
{% load static %}

{% block breadcrumb %}
<div>
    <h1><i class="app-menu__icon fa fa-bug"></i> Detalhe o problema da sua plantação</h1>
</div>
{% endblock breadcrumb %}

{% block extracss %}
<link rel="stylesheet" href="{% static 'css/cards.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    body {
        background-color: #f5f5f5; /* Fundo mais agradável visualmente */
    }

    .container-flex {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        max-width: 1200px;
        margin: 30px auto;
    }

    .problem-form,
    .resultado-container {
        background-color: #ffffff; /* Cor de fundo */
        border: 2px solid #28a745; /* Borda verde */
        border-radius: 15px; /* Cantos arredondados */
        padding: 30px; /* Espaçamento interno */
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); /* Sombra suave */
        display: flex;
        flex-direction: column; /* Permite o alinhamento vertical */
        flex: 1; /* Faz as duas áreas ocuparem a mesma altura */
        height: 640px; /* Altura fixa para o contêiner */
        overflow: hidden; /* Esconde qualquer conteúdo que ultrapasse a altura */
    }

    .form-textarea {
        flex: 1; /* Faz o textarea crescer para ocupar espaço */
        width: 100%; /* Largura completa do textarea */
        border: 1px solid #ccc; /* Borda cinza */
        border-radius: 8px; /* Cantos arredondados */
        padding: 15px; /* Espaçamento interno */
        font-size: 18px; /* Tamanho da fonte aumentado */
        resize: none; /* Não permite redimensionar */
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1); /* Sombra interna */
        margin-bottom: 15px; /* Margem inferior */
    }

    .resultado-container {
        overflow-y: auto; /* Adiciona rolagem vertical */
    }

    .section-title {
        text-align: center; /* Centraliza o título da seção */
        font-size: 28px; /* Tamanho da fonte do título */
        margin-bottom: 20px; /* Margem inferior */
        color: #333; /* Cor do texto */
    }

    .plantio-info {
        background-color: #e9f5e9; /* Fundo leve para destacar */
        border: 1px solid #28a745; /* Borda verde */
        border-radius: 10px; /* Cantos arredondados */
        padding: 15px; /* Espaçamento interno */
        margin-bottom: 20px; /* Margem inferior */
        display: flex; /* Usa flexbox para melhor alinhamento */
        align-items: center; /* Alinha os itens verticalmente ao centro */
        justify-content: flex-start; /* Alinha os itens à esquerda */
        height: 80px; /* Defina uma altura fixa desejada */
    }

    .plantio-info i.icon {
        font-size: 2em; /* Aumenta o tamanho do ícone */
        margin-right: 10px; /* Espaço entre o ícone e o texto */
        color: #28a745; /* Cor verde para o ícone */
    }

    .plantio-info .icon2 {
        font-size: 1.4em; /* Aumenta o tamanho do ícone */
        margin-right: 10px; /* Espaço entre o ícone e o texto */
        color: #28a745; /* Cor verde para o ícone */
    }

    .plantio-name {
        font-weight: bold; /* Texto em negrito */
        font-size: 20px; /* Tamanho da fonte do plantio selecionado */
        color: #28a745; /* Cor verde */
        margin: 0; /* Remove margens para melhor alinhamento */
    }

    .btn-submit {
        background-color: #28a745; /* Cor do botão */
        color: white; /* Cor do texto do botão */
        border: none; /* Remove a borda */
        border-radius: 2rem; /* Cantos arredondados */
        padding: 12px 25px; /* Espaçamento interno do botão */
        font-size: 20px; /* Tamanho da fonte do botão */
        cursor: pointer; /* Muda o cursor ao passar o mouse */
        transition: background-color 0.3s, transform 0.2s; /* Transições suaves */
    }

    .btn-submit:hover {
        background-color: #218838; /* Cor do botão ao passar o mouse */
        transform: translateY(-2px); /* Levanta o botão ao passar o mouse */
        color: white;
    }

    .btn-submit:active {
        transform: translateY(1px); /* Efeito de pressão ao clicar */
    }

    .resultado-container h3 {
        margin-bottom: 10px; /* Margem inferior */
        color: #28a745; /* Cor do título */
    }

    .resultado-container p {
        font-size: 18px; /* Tamanho da fonte dos parágrafos */
        margin: 5px 0; /* Margem vertical */
    }

    .resultado-info {
        margin-top: 15px; /* Margem superior */
    }

    .resultado-item {
        font-size: 18px; /* Tamanho da fonte */
        margin: 10px 0; /* Margens verticais */
        color: #333; /* Cor do texto principal */
    }

    .resultado-item strong {
        color: #28a745; /* Verde para os rótulos */
    }

    .resultado-dado {
        color: #333; /* Verde para os dados */
        font-weight: bold; /* Texto em negrito */
    }
</style>
{% endblock extracss %}

{% block content %}
<div class="container-flex">
    <form id="detalheProblemaForm" class="problem-form" method="post">
        {% csrf_token %}
        <div class="plantio-info">
            {% if plantio_selecionado == "Batata" %}
                <i class="fas fa-seedling icon"></i>
            {% elif plantio_selecionado == "Cenoura" %}
                <i class="fas fa-carrot icon"></i>
            {% elif plantio_selecionado == "Tomate" %}
                <i class="fas fa-apple-alt icon"></i>
            {% elif plantio_selecionado == "Alface" %}
                <i class="fas fa-leaf icon"></i>
            {% elif plantio_selecionado == "Rucula" %}
                <i class="fas fa-spa icon"></i>
            {% endif %}
            <p class="plantio-name">{{ plantio_selecionado }}</p>
        </div>  
        <input type="hidden" name="plantio" value="{{ plantio_selecionado }}">
        <textarea id="detalhes" name="detalhes" rows="6" placeholder="Descreva o problema..." class="form-textarea"></textarea>
        <button type="submit" class="btn btn-submit">Resolva meu problema <i class="bi bi-send-fill" style="margin-left: 0.8rem;"></i></button>
    </form>

    <div class="resultado-container">
        <div class="plantio-info">
            <p class="plantio-name"><i class="fas fa-lightbulb icon2"></i> Possíveis pragas e doenças encontradas:</p>
        </div>
        <div id="resultadoRecomendacao" class="resultado">
            <!-- O resultado será inserido aqui pelo script -->
        </div>
    </div>
</div>

<div class="col-md-13">
    <div class="tile-13">
        <div class="tile-body-13">
            <div class="table-responsive-13">
                <div id="sampleTable_wrapper-13" class="dataTables_wrapper container-fluid dt-bootstrap4 no-footer">
                    <div class="row-13">
                        <div class="col-sm-12">
                            <table class="table table-hover table-bordered dataTable no-footer-13" id="sampleTable-13" role="grid" aria-describedby="sampleTable_info">
                                <thead>
                                    <tr role="row">
                                        <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1" colspan="1" style="width: 600px;">N°</th>
                                        <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1" colspan="1" style="width: 600px;">Tipo de plantio</th>
                                        <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1" colspan="1" style="width: 600px;">Data de reporte</th>
                                        <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1" colspan="1" style="width: 600px;">Problema descrito</th>
                                        <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1" colspan="1" style="width: 600px;">Resolvido?</th>
                                    </tr> 
                                </thead>
                                <tbody>
                                        <tr role="row" class="odd-13">
                                            <!--sera adicionada aqui pelo js-->
                                        </tr>
                            </table>
                            <div id="navigation-buttons">
                                <!-- Se houver mais dados, adicione botões para navegação -->
                                <button id="prevPage" class="btn btn-secondary">Anterior</button>
                                <button id="nextPage" class="btn btn-secondary">Próximo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modalConfirmacao" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="fecharModal()">&times;</span>
        <h3>Confirmar Seleção</h3>
        <p id="modalTexto">Você deseja confirmar esta praga ou doença?</p>
        <button class="btn btn-modal" onclick="confirmarAdicao()">Confirmar</button>
    </div>
</div>



<!-- Script para AJAX -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tabelaBody = document.querySelector("#sampleTable-13 tbody");
        let currentPage = 0; // Página inicial
        const rowsPerPage = 5; // Número de linhas visíveis por vez
        let problemas = []; // Array para armazenar os problemas carregados e adicionados manualmente
    
        // Função para renderizar a página
        function renderPage() {
            tabelaBody.innerHTML = ''; // Limpa a tabela antes de renderizar novos dados
            const start = currentPage * rowsPerPage;
            const end = start + rowsPerPage;
            const problemasPagina = problemas.slice(start, end);
    
            problemasPagina.forEach((problema, index) => {
                const novaLinha = document.createElement('tr');
                novaLinha.innerHTML = 
                    `<td>${start + index + 1}</td>`  // Numeração contínua
                    + `<td>${problema.plantio}</td>`
                    + `<td>${problema.data_reporte}</td>`
                    + `<td>${problema.descricao}</td>`
                    + `<td>${problema.resolvido ? 'Sim' : 'Não'}</td>`;
                tabelaBody.appendChild(novaLinha);
            });
        }
    
        fetch("{% url 'site_cc:listar_problemas' %}", {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                problemas = data.problemas; // Armazena os problemas recebidos
                renderPage(); // Renderiza a primeira página
            } else {
                console.error('Erro ao carregar os problemas:', data.message);
            }
        })
        .catch(error => {
            console.error('Erro ao carregar os problemas:', error);
        });
    
        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(problemas.length / rowsPerPage);
            if (currentPage < totalPages - 1) {
                currentPage++;
                renderPage();
            }
        });
    
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                renderPage();
            }
        });
    
        function adicionarProblema(problema) {
            problemas.unshift(problema); // Adiciona o novo problema no começo do array
            renderPage(); // Re-renderiza a tabela para mostrar o novo problema
        }
    
        function confirmarAdicao() {
            fecharModal(); 
    
            if (!itemAtual.nome || !itemAtual.plantio || !itemAtual.descricaoProblema) {
                console.error('Dados incompletos para a tabela:', itemAtual);
                return; 
            }
    
            const novoProblema = {
                plantio: itemAtual.plantio,
                descricao: itemAtual.descricaoProblema,
                data_reporte: new Date().toLocaleDateString(),
                resolvido: itemAtual.resolvido,
            };
    
            adicionarProblema(novoProblema); // Adiciona o novo problema
            itemAtual = {}; // Reseta o item atual
            tipoAtual = '';  // Reseta o tipo atual
        }
    
        function abrirModal(tipo, index) {
            const modal = document.getElementById('modalConfirmacao');
            modal.style.display = 'block';
    
            tipoAtual = tipo;
            itemAtual = tipo === 'doenca' ? data.doencas[index] : data.pragas[index];
    
            const plantioSelecionado = document.querySelector(".plantio-name").innerText; // Tipo de plantio selecionado
            const descricaoProblema = document.getElementById('detalhes').value; // Descrição do problema
    
            itemAtual.plantio = plantioSelecionado;
            itemAtual.descricaoProblema = descricaoProblema;
            itemAtual.resolvido = false;  // O problema ainda não foi resolvido
    
            const modalTexto = document.getElementById('modalTexto');
            modalTexto.innerHTML = 
                `Você deseja confirmar a ${tipo === 'doenca' ? 'doença' : 'praga'}: <strong>${itemAtual.nome}</strong>?<br>
                Tipo de Plantio: ${itemAtual.plantio}<br>
                Descrição do Problema: ${itemAtual.descricaoProblema}`;
        }
    
        function fecharModal() {
            const modal = document.getElementById('modalConfirmacao');
            modal.style.display = 'none';
        }
    
        document.querySelector('.btn-modal').addEventListener('click', confirmarAdicao);
    
        // Configura o formulário de envio AJAX
        document.getElementById('detalheProblemaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const resultadoDiv = document.getElementById('resultadoRecomendacao');
    
            resultadoDiv.innerHTML = '<p>Carregando...</p>';
    
            fetch("{% url 'site_cc:detectar_pragas_doencas' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                resultadoDiv.innerHTML = '';
                if (data.success) {
                    const problema = data.problema;
                    adicionarProblema({
                        plantio: problema.plantio,
                        descricao: problema.descricao,
                        data_reporte: problema.data_reporte,
                        resolvido: problema.resolvido
                    });
    
                    resultadoDiv.innerHTML = 
                        `<h3>Doenças:</h3>`
                        + `${data.doencas.length ? data.doencas.map((doenca, index) => 
                            `<div class="resultado-info">
                                <p class="resultado-item"><strong>Nome:</strong> ${doenca.nome}</p>
                                <p class="resultado-item"><strong>Descrição:</strong> ${doenca.descricao}</p>
                                <p class="resultado-item"><strong>Tratamento:</strong> ${doenca.tratamento}</p>
                                <button class="btn btn-confirmar" onclick="abrirModal('doenca', ${index})">Confirmar</button>
                            </div>`
                        ).join('') : '<p>Nenhuma doença identificada.</p>'}`
                        + `<h3>Pragas:</h3>`
                        + `${data.pragas.length ? data.pragas.map((praga, index) => 
                            `<div class="resultado-info">
                                <p class="resultado-item"><strong>Nome:</strong> ${praga.nome}</p>
                                <p class="resultado-item"><strong>Descrição:</strong> ${praga.descricao}</p>
                                <p class="resultado-item"><strong>Tratamento:</strong> ${praga.tratamento}</p>
                                <button class="btn btn-confirmar" onclick="abrirModal('praga', ${index})">Confirmar</button>
                            </div>`
                        ).join('') : '<p>Nenhuma praga identificada.</p>'}`;
                } else {
                    resultadoDiv.innerHTML = `<p>${data.message}</p>`;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                resultadoDiv.innerHTML = '<p>Ocorreu um erro ao processar sua solicitação.</p>';
            });
        });
    });
    
</script>    

{% endblock content %}
